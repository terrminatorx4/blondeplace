name: üöÄ BlondePlace Beauty Factory (MEGA POWER)

on:
  workflow_dispatch:
    inputs:
      model_choice:
        description: '–í—ã–±–æ—Ä AI –º–æ–¥–µ–ª–∏'
        required: true
        default: 'gemini'
        type: choice
        options:
        - gemini
        - openrouter
      batch_size_per_thread:
        description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π –Ω–∞ –ø–æ—Ç–æ–∫'
        required: true
        default: '5'
        type: string
      threads:
        description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤'
        required: true
        default: '10'
        type: string

env:
  NODE_VERSION: '18'

jobs:
  beauty-content-generation:
    name: üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Beauty –ö–æ–Ω—Ç–µ–Ω—Ç–∞ (–ü–æ—Ç–æ–∫ ${{ matrix.thread }})
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        thread: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
      max-parallel: 10
      fail-fast: false
    
    if: ${{ matrix.thread <= fromJSON(github.event.inputs.threads || '10') }}
    
    steps:
      - name: üõí Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üèóÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: |
          npm ci
          npm list --depth=0

      - name: üîë Setup API Keys
        id: set_key
        run: |
          if [ "${{ github.event.inputs.model_choice }}" == "gemini" ]; then
            echo "key=${{ secrets.GEMINI_API_KEY }}" >> $GITHUB_OUTPUT
          else
            echo "key=${{ secrets.OPENROUTER_API_KEY }}" >> $GITHUB_OUTPUT
          fi

      - name: üé® Run Beauty Factory & üì¢ Publish & Notify (Thread ${{ matrix.thread }})
        env:
          MODEL_CHOICE: ${{ github.event.inputs.model_choice || 'gemini' }}
          API_KEY_CURRENT: ${{ steps.set_key.outputs.key }}
          BATCH_SIZE: ${{ github.event.inputs.batch_size_per_thread || 5 }}
          TOTAL_THREADS: ${{ github.event.inputs.threads || 10 }}
          THREAD_ID: ${{ matrix.thread }}
        run: |
          git config --global user.name 'BlondePlace Beauty Bot'
          git config --global user.email 'beauty-bot@blondeplace.ru'
          git config --global pull.rebase false
          
          echo "--- üé® BEAUTY –ü–û–¢–û–ö #${{ matrix.thread }}: –ù–∞—á–∏–Ω–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é beauty –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ---"
          
          npm run factory
          
          if [[ -z $(git status --porcelain) ]]; then
            echo "‚úÖ üé® BEAUTY –ü–û–¢–û–ö #${{ matrix.thread }}: –ù–æ–≤—ã—Ö beauty —Å—Ç–∞—Ç–µ–π –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. Beauty –º–∏—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞."
            exit 0
          fi

          echo "üî• üé® BEAUTY –ü–û–¢–û–ö #${{ matrix.thread }}: –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ —Å—Ç–∞—Ç—å–∏ –æ –∫—Ä–∞—Å–æ—Ç–µ. –ù–∞—á–∏–Ω–∞—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É –ø—É–±–ª–∏–∫–∞—Ü–∏–∏..."
          
          MAX_RETRIES=5
          RETRY_DELAY=5
          
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "üìù BEAUTY –ü–û–¢–û–ö #${{ matrix.thread }}: –ü–æ–ø—ã—Ç–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ #$attempt –∏–∑ $MAX_RETRIES..."
            
            git add .
            git commit -m "üé® Beauty —Å—Ç–∞—Ç—å–∏: –ø–æ—Ç–æ–∫ #${{ matrix.thread }} (${{ github.event.inputs.batch_size_per_thread || 5 }} —à—Ç.) [${{ github.event.inputs.model_choice || 'gemini' }}]"
            
            if git push origin main; then
              echo "‚úÖ üé® BEAUTY –ü–û–¢–û–ö #${{ matrix.thread }}: –°—Ç–∞—Ç—å–∏ —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã –≤ GitHub!"
              break
            else
              echo "‚ö†Ô∏è BEAUTY –ü–û–¢–û–ö #${{ matrix.thread }}: –ö–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏. –û–±–Ω–æ–≤–ª—è—é –∏ –ø–æ–≤—Ç–æ—Ä—è—é –ø–æ–ø—ã—Ç–∫—É..."
              git pull --rebase origin main || git pull --no-rebase origin main
              sleep $RETRY_DELAY
            fi
            
            if [ $attempt -eq $MAX_RETRIES ]; then
              echo "‚ùå BEAUTY –ü–û–¢–û–ö #${{ matrix.thread }}: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ $MAX_RETRIES –ø–æ–ø—ã—Ç–æ–∫"
              exit 1
            fi
          done
          
          echo "üéâ BEAUTY –ü–û–¢–û–ö #${{ matrix.thread }}: Beauty –∫–æ–Ω—Ç–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!"
