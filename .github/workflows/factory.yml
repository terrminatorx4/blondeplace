name: ğŸš€ BlondePlace Beauty Factory (Atomic Lock)

on:
  workflow_dispatch:
    inputs:
      topic_count:
        description: 'ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑÑ‚Ğ°Ñ‚ĞµĞ¹ Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '5'
          - '10'
          - '20'
      category:
        description: 'ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ ÑÑ‚Ğ°Ñ‚ĞµĞ¹'
        required: true
        default: 'hair-care'
        type: choice
        options:
          - 'hair-care'
          - 'hair-coloring'
          - 'nail-care'
          - 'beauty-tips'
          - 'salon-news'

jobs:
  generate_and_publish:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      matrix:
        thread: ${{ fromJson(format('[{0}]', join(range(1, fromJson(github.event.inputs.topic_count) + 1), ', '))) }}
      max-parallel: 20
      fail-fast: false

    steps:
      - name: âœ… Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ”§ Install Dependencies
        run: |
          npm install
          echo "Dependencies installed successfully"

      - name: ğŸ”‘ Get API Keys from Pool
        id: get-keys
        run: |
          echo "ğŸ”‘ Processing API keys for thread ${{ matrix.thread }}"
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ»ÑÑ‡Ğ¸ Ğ¸Ğ· GitHub Secrets (Ğ¿ÑƒĞ» Ğ¸Ğ· 20 ĞºĞ»ÑÑ‡ĞµĞ¹)
          GEMINI_KEYS_RAW="${{ secrets.GEMINI_API_KEYS_POOL }}"
          OPENROUTER_KEYS_RAW="${{ secrets.OPENROUTER_API_KEYS_POOL }}"
          
          if [ -z "$GEMINI_KEYS_RAW" ] || [ -z "$OPENROUTER_KEYS_RAW" ]; then
            echo "âŒ API keys are empty!"
            exit 1
          fi
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¼Ğ°ÑÑĞ¸Ğ²Ñ‹ ĞºĞ»ÑÑ‡ĞµĞ¹
          echo "$GEMINI_KEYS_RAW" | tr ',' '\n' > gemini_keys.txt
          echo "$OPENROUTER_KEYS_RAW" | tr ',' '\n' > openrouter_keys.txt
          
          # Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ¸Ğ½Ğ´ĞµĞºÑ Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ° (1-20 -> 1-20)
          THREAD_NUM=${{ matrix.thread }}
          INDEX=$(( ($THREAD_NUM - 1) % 20 + 1 ))
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ»ÑÑ‡Ğ¸ Ğ¿Ğ¾ Ğ¸Ğ½Ğ´ĞµĞºÑÑƒ
          GEMINI_KEY=$(sed -n "${INDEX}p" gemini_keys.txt | tr -d '[:space:]')
          OPENROUTER_KEY=$(sed -n "${INDEX}p" openrouter_keys.txt | tr -d '[:space:]')
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ ĞºĞ»ÑÑ‡Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ñ‹
          if [ -z "$GEMINI_KEY" ] || [ -z "$OPENROUTER_KEY" ]; then
            echo "âŒ Failed to get API keys for thread $THREAD_NUM"
            echo "ğŸ“ Using fallback keys..."
            GEMINI_KEY=$(head -n1 gemini_keys.txt | tr -d '[:space:]')
            OPENROUTER_KEY=$(head -n1 openrouter_keys.txt | tr -d '[:space:]')
          fi
          
          # Ğ’Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
          echo "GEMINI_API_KEY=$GEMINI_KEY" >> $GITHUB_ENV
          echo "OPENROUTER_API_KEY=$OPENROUTER_KEY" >> $GITHUB_ENV
          
          echo "âœ… Thread $THREAD_NUM using key index: $INDEX"
          
          # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
          rm -f gemini_keys.txt openrouter_keys.txt

      - name: ğŸ­ Generate Content (Thread ${{ matrix.thread }})
        env:
          MODEL_CHOICE: "gemini"
          BATCH_SIZE: "1"
          THREAD_ID: ${{ matrix.thread }}
          CATEGORY: ${{ github.event.inputs.category }}
        run: |
          git config --global user.name 'BlondePlace Beauty Bot'
          git config --global user.email 'beauty-bot@blondeplace.ru'
          
          echo "--- ğŸ¨ BEAUTY ĞŸĞĞ¢ĞĞš #${{ matrix.thread }}: ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ beauty ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ° ---"
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ factory.js Ñ‡ĞµÑ€ĞµĞ· npm script
          npm run factory
          
          if [[ -z $(git status --porcelain) ]]; then
            echo "âœ… Thread ${{ matrix.thread }}: ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ¸Ğ»Ğ¸ Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½"
            exit 0
          fi
          
          echo "ğŸ”¥ Thread ${{ matrix.thread }}: ĞĞ°Ğ¹Ğ´ĞµĞ½ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ beauty ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚. ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒÑ..."
          
          git add src/content/posts/*.md
          git commit -m "ğŸ¨ Beauty content from thread ${{ matrix.thread }} (${{ github.event.inputs.category }})"
          git pull --rebase
          git push

      - name: ğŸ‰ Thread Success
        if: success()
        run: |
          echo "âœ… BEAUTY THREAD ${{ matrix.thread }} COMPLETED"
          echo "ğŸ“‚ Category: ${{ github.event.inputs.category }}"
          echo "ğŸ¨ Beauty content generated successfully"

  completion:
    needs: generate_and_publish
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸŠ Beauty Factory Report
        run: |
          echo "ğŸš€ BLONDE PLACE BEAUTY FACTORY COMPLETED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Generated articles: ${{ github.event.inputs.topic_count }}"
          echo "ğŸ“‚ Category: ${{ github.event.inputs.category }}"
          echo "ğŸŒ Site: https://blondeplace.netlify.app/"
          echo "ğŸ”— Blog: https://blondeplace.netlify.app/blog/"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Beauty mission accomplished!"