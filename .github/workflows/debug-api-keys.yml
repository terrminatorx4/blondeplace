name: üîç DEBUG: API Keys Extraction Test

on:
  workflow_dispatch:
    inputs:
      model_choice:
        description: '–ö–∞–∫—É—é –º–æ–¥–µ–ª—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏?'
        required: true
        default: 'gemini'
        type: choice
        options:
        - gemini
        - deepseek
      batch_size_per_thread:
        description: '–°–∫–æ–ª—å–∫–æ —Å—Ç–∞—Ç–µ–π –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ö–ê–ñ–î–´–ú –ø–æ—Ç–æ–∫–æ–º?'
        required: true
        default: '1'
      threads:
        description: '–°–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ –∑–∞–ø—É—Å—Ç–∏—Ç—å –û–î–ù–û–í–†–ï–ú–ï–ù–ù–û?'
        required: true
        default: '20'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set_matrix.outputs.matrix }}
    steps:
      - name: Create thread matrix
        id: set_matrix
        run: |
          MAX_THREADS=30
          REQUESTED_THREADS=${{ github.event.inputs.threads || 20 }}

          if (( REQUESTED_THREADS > MAX_THREADS )); then
            echo "::warning::–ó–∞–ø—Ä–æ—à–µ–Ω–æ –±–æ–ª—å—à–µ –ø–æ—Ç–æ–∫–æ–≤ (${REQUESTED_THREADS}), —á–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ –∫–ª—é—á–µ–π (${MAX_THREADS}). –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ ${MAX_THREADS}."
            REQUESTED_THREADS=$MAX_THREADS
          fi

          threads=$(seq 1 $REQUESTED_THREADS)
          echo "matrix=[$(echo $threads | tr ' ' ',')]" >> $GITHUB_OUTPUT

  generate_and_publish:
    needs: prepare
    permissions:
      contents: write

    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        thread: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - name: ‚¨áÔ∏è Checkout repo (Thread ${{ matrix.thread }})
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup Node.js (Thread ${{ matrix.thread }})
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install dependencies (Thread ${{ matrix.thread }})
        run: npm install

      - name: üîç DEBUG: Check secrets availability (Thread ${{ matrix.thread }})
        run: |
          echo "üîç [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] === –û–¢–õ–ê–î–ö–ê –°–ï–ö–†–ï–¢–û–í ==="
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤
          if [[ -n "${{ secrets.GEMINI_API_KEYS_POOL }}" ]]; then
            echo "‚úÖ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] GEMINI_API_KEYS_POOL –Ω–∞–π–¥–µ–Ω"
            echo "üìè [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –î–ª–∏–Ω–∞ GEMINI_API_KEYS_POOL: $(echo '${{ secrets.GEMINI_API_KEYS_POOL }}' | wc -c) —Å–∏–º–≤–æ–ª–æ–≤"
            echo "üìÑ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ GEMINI_API_KEYS_POOL: $(echo '${{ secrets.GEMINI_API_KEYS_POOL }}' | wc -l)"
            echo "üî§ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –ü–µ—Ä–≤—ã–µ 20 —Å–∏–º–≤–æ–ª–æ–≤: $(echo '${{ secrets.GEMINI_API_KEYS_POOL }}' | head -c 20)..."
          else
            echo "‚ùå [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] GEMINI_API_KEYS_POOL –ù–ï –ù–ê–ô–î–ï–ù!"
          fi
          
          if [[ -n "${{ secrets.OPENROUTER_API_KEYS_POOL }}" ]]; then
            echo "‚úÖ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] OPENROUTER_API_KEYS_POOL –Ω–∞–π–¥–µ–Ω"
          else
            echo "‚ùå [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] OPENROUTER_API_KEYS_POOL –ù–ï –ù–ê–ô–î–ï–ù!"
          fi

      - name: üîë DEBUG: Set API Key for Thread ${{ matrix.thread }}
        id: set_key
        run: |
          echo "üîç [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] === –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –ö–õ–Æ–ß–ê ==="
          
          MODEL_CHOICE="${{ github.event.inputs.model_choice || 'gemini' }}"
          echo "üéØ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –í—ã–±—Ä–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å: $MODEL_CHOICE"
          
          if [ "$MODEL_CHOICE" == "deepseek" ]; then
            API_KEYS="${{ secrets.OPENROUTER_API_KEYS_POOL }}"
            echo "üîÑ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –ò—Å–ø–æ–ª—å–∑—É–µ–º OPENROUTER_API_KEYS_POOL"
          else
            API_KEYS="${{ secrets.GEMINI_API_KEYS_POOL }}"
            echo "üîÑ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –ò—Å–ø–æ–ª—å–∑—É–µ–º GEMINI_API_KEYS_POOL"
          fi

          echo "üìä [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π –≤ –ø—É–ª–µ: $(echo "$API_KEYS" | wc -l)"
          echo "üìç [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –ò–∑–≤–ª–µ–∫–∞—é –∫–ª—é—á –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏: ${{ matrix.thread }}"

          CURRENT_KEY=$(echo "$API_KEYS" | sed -n '${{ matrix.thread }}p' | tr -d '\r')
          
          echo "üîç [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑–≤–ª–µ—á–µ–Ω–∏—è:"
          if [[ -z "$CURRENT_KEY" ]]; then
            echo "‚ùå [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –ö–õ–Æ–ß –ù–ï –ù–ê–ô–î–ï–ù –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ ${{ matrix.thread }}!"
            echo "üìã [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –ø—É–ª–µ:"
            echo "$API_KEYS" | nl -nln
            echo "::error::–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å API-–∫–ª—é—á –¥–ª—è –ø–æ—Ç–æ–∫–∞ #${{ matrix.thread }} –¥–ª—è –º–æ–¥–µ–ª–∏ ${MODEL_CHOICE}."
            exit 1
          else
            echo "‚úÖ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –ö–ª—é—á —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω"
            echo "üî§ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –î–ª–∏–Ω–∞ –∫–ª—é—á–∞: ${#CURRENT_KEY} —Å–∏–º–≤–æ–ª–æ–≤"
            echo "üî§ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –ü–µ—Ä–≤—ã–µ 10 —Å–∏–º–≤–æ–ª–æ–≤: ${CURRENT_KEY:0:10}..."
            echo "üî§ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –ü–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Å–∏–º–≤–æ–ª–∞: ...${CURRENT_KEY: -4}"
          fi
          
          echo "key=$CURRENT_KEY" >> $GITHUB_OUTPUT

      - name: üîç DEBUG: Test API_KEY_CURRENT availability
        env:
          MODEL_CHOICE: ${{ github.event.inputs.model_choice || 'gemini' }}
          API_KEY_CURRENT: ${{ steps.set_key.outputs.key }}
          BATCH_SIZE: ${{ github.event.inputs.batch_size_per_thread || 1 }}
          TOTAL_THREADS: ${{ github.event.inputs.threads || 20 }}
          THREAD_ID: ${{ matrix.thread }}
        run: |
          echo "üîç [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] === –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–ú–ï–ù–ù–´–• –û–ö–†–£–ñ–ï–ù–ò–Ø ==="
          
          echo "üéØ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] MODEL_CHOICE: $MODEL_CHOICE"
          echo "üéØ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] THREAD_ID: $THREAD_ID"
          echo "üéØ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] BATCH_SIZE: $BATCH_SIZE"
          echo "üéØ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] TOTAL_THREADS: $TOTAL_THREADS"
          
          if [[ -n "$API_KEY_CURRENT" ]]; then
            echo "‚úÖ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] API_KEY_CURRENT —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            echo "üî§ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –î–ª–∏–Ω–∞ API_KEY_CURRENT: ${#API_KEY_CURRENT} —Å–∏–º–≤–æ–ª–æ–≤"
            echo "üî§ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –ü–µ—Ä–≤—ã–µ 10 —Å–∏–º–≤–æ–ª–æ–≤: ${API_KEY_CURRENT:0:10}..."
            echo "üî§ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –ü–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Å–∏–º–≤–æ–ª–∞: ...${API_KEY_CURRENT: -4}"
          else
            echo "‚ùå [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] API_KEY_CURRENT –ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù!"
            echo "üîç [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å 'API' –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏:"
            env | grep -i api || echo "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å 'API'"
            exit 1
          fi

      - name: üß™ TEST: Run Factory.js with debug (Thread ${{ matrix.thread }})
        env:
          MODEL_CHOICE: ${{ github.event.inputs.model_choice || 'gemini' }}
          API_KEY_CURRENT: ${{ steps.set_key.outputs.key }}
          BATCH_SIZE: ${{ github.event.inputs.batch_size_per_thread || 1 }}
          TOTAL_THREADS: ${{ github.event.inputs.threads || 20 }}
          THREAD_ID: ${{ matrix.thread }}
        run: |
          echo "üß™ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] === –¢–ï–°–¢ –ó–ê–ü–£–°–ö–ê FACTORY.JS ==="
          
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions-bot@github.com'
          git config --global pull.rebase false

          echo "--- –≠–°–ö–ê–î–†–û–ù #${{ matrix.thread }}: –ù–∞—á–∏–Ω–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é (DEBUG –†–ï–ñ–ò–ú) ---"

          npm run factory

          echo "‚úÖ [–ü–æ—Ç–æ–∫ #${{ matrix.thread }}] Factory.js –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!" 