name: ALPHA-STRIKE v5.2-RACE-FIXED

on:
  workflow_dispatch:
    inputs:
      target_articles:
        description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏'
        required: true
        default: '50'
        type: string
      model_choice:
        description: '–í—ã–±–æ—Ä AI –º–æ–¥–µ–ª–∏'
        required: true
        default: 'gemini'
        type: choice
        options:
        - gemini
        - openrouter

jobs:
  alpha-strike-attack:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    strategy:
      max-parallel: 20
      fail-fast: false  # –ö–†–ò–¢–ò–ß–ù–û: –ù–ï –æ—Ç–º–µ–Ω—è—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ jobs –ø—Ä–∏ —Å–±–æ–µ –æ–¥–Ω–æ–≥–æ
      matrix:
        thread-id: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies  
      run: |
        npm install googleapis node-fetch@2.6.7 execa@5.1.1 slugify@1.6.6

    - name: SETUP API KEYS
      run: |
        if [ "${{ github.event.inputs.model_choice }}" = "gemini" ]; then
          KEYS_POOL="${{ secrets.GEMINI_API_KEYS_POOL }}"
          KEY_INDEX=${{ matrix.thread-id }}
          API_KEY=$(echo "$KEYS_POOL" | tr ',' '\n' | sed -n "${KEY_INDEX}p")
          echo "GEMINI_API_KEY_CURRENT=$API_KEY" >> $GITHUB_ENV
          echo "MODEL_CHOICE=gemini" >> $GITHUB_ENV
        else
          KEYS_POOL="${{ secrets.OPENROUTER_API_KEYS_POOL }}"
          KEY_INDEX=${{ matrix.thread-id }}
          API_KEY=$(echo "$KEYS_POOL" | tr ',' '\n' | sed -n "${KEY_INDEX}p")
          echo "OPENROUTER_API_KEY_CURRENT=$API_KEY" >> $GITHUB_ENV
          echo "MODEL_CHOICE=openrouter" >> $GITHUB_ENV
        fi

    - name: ALPHA-STRIKE GENERATION
      run: |
        echo "üéØ –≠–°–ö–ê–î–†–û–ù #${{ matrix.thread-id }}: –ù–∞—á–∏–Ω–∞—é Alpha-Strike –∞—Ç–∞–∫—É!"
        export THREAD_ID=${{ matrix.thread-id }}
        export TARGET_ARTICLES=${{ github.event.inputs.target_articles }}
        node alpha-factory.js

    - name: SUPER-SAFE GIT OPERATIONS (RACE-PROOF)
      run: |
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git
        git config --local user.email "action@github.com"
        git config --local user.name "Alpha-Strike Bot"
        
        # –£–°–ò–õ–ï–ù–ù–ê–Ø –ó–ê–©–ò–¢–ê –û–¢ RACE CONDITIONS
        RANDOM_DELAY=$((RANDOM % 90 + 30))  # 30-120 —Å–µ–∫—É–Ω–¥ –≤–º–µ—Å—Ç–æ 5-35
        echo "üõ°Ô∏è Thread ${{ matrix.thread-id }}: –ó–ê–©–ò–¢–ê –û–¢ RACE - –∂–¥—ë–º ${RANDOM_DELAY}s..."
        sleep ${RANDOM_DELAY}
        
        # –°–£–ü–ï–†-RETRY –ú–ï–•–ê–ù–ò–ó–ú (10 –ø–æ–ø—ã—Ç–æ–∫ –≤–º–µ—Å—Ç–æ 5)
        for attempt in {1..10}; do
          echo "üîÑ Thread ${{ matrix.thread-id }}: Git push –ø–æ–ø—ã—Ç–∫–∞ $attempt/10"
          
          # –°—Ç—Ä–∞—Ç–µ–≥–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ push
          git stash push -m "temp-stash-${{ matrix.thread-id }}-$attempt" || true
          git pull --rebase origin main || true
          git stash pop || true
          
          # –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git add src/content/posts/ || true
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —á—Ç–æ –∫–æ–º–º–∏—Ç–∏—Ç—å
          if git diff --staged --quiet; then
            echo "‚úÖ Thread ${{ matrix.thread-id }}: –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è commit"
            break
          fi
          
          # –ö–æ–º–º–∏—Ç —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
          git commit -m "üéØ Alpha-Strike v5.2: Thread ${{ matrix.thread-id }} - Attempt $attempt - $(date)" || true
          
          # –ü—Ä–æ–±—É–µ–º push
          if git push origin main; then
            echo "‚úÖ Thread ${{ matrix.thread-id }}: Git push —É—Å–ø–µ—à–µ–Ω –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ $attempt!"
            break
          else
            echo "‚ö†Ô∏è Thread ${{ matrix.thread-id }}: Git push –Ω–µ—É–¥–∞—á–µ–Ω, –ø–æ–ø—ã—Ç–∫–∞ $attempt"
            if [ $attempt -eq 10 ]; then
              echo "‚ùå Thread ${{ matrix.thread-id }}: –í—Å–µ 10 –ø–æ–ø—ã—Ç–æ–∫ –∏—Å—á–µ—Ä–ø–∞–Ω—ã"
              exit 1
            fi
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
            sleep $((RANDOM % 30 + 10))
          fi
        done

    - name: REPORT GENERATION  
      run: |
        echo "‚úÖ –≠–°–ö–ê–î–†–û–ù #${{ matrix.thread-id }}: Alpha-Strike –º–∏—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
        echo "üéØ Model: ${{ github.event.inputs.model_choice }}"
        echo "üìä Target articles: ${{ github.event.inputs.target_articles }}"

  quality-control:
    needs: alpha-strike-attack
    runs-on: ubuntu-latest
    if: always()  # –ó–∞–ø—É—Å–∫–∞–µ–º –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ jobs –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å
    steps:
    - name: Checkout repository  
      uses: actions/checkout@v4

    - name: QUALITY CONTROL
      run: |
        echo "üîç –ö–û–ù–¢–†–û–õ–¨ –ö–ê–ß–ï–°–¢–í–ê ALPHA-STRIKE v5.2"
        echo ""
        echo "üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–û–ó–î–ê–ù–ù–´–• –°–¢–ê–¢–ï–ô:"
        find src/content/posts -name "post*.md" -newer .git/logs/HEAD | wc -l || echo "0"
        echo ""
        echo "üîó –ü–†–Ø–ú–´–ï –°–°–´–õ–ö–ò –ù–ê –ù–û–í–´–ï –°–¢–ê–¢–¨–ò:"
        find src/content/posts -name "post*.md" -newer .git/logs/HEAD | head -10 | while read file; do
          filename=$(basename "$file" .md)
          echo "  üìÑ https://blondeplace.netlify.app/blog/$filename/"
        done

  final-report:
    needs: [alpha-strike-attack, quality-control]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: FINAL REPORT
      run: |
        echo "üéØ –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–Å–¢ ALPHA-STRIKE v5.2-RACE-FIXED"
        echo ""
        echo "‚úÖ –ú–ò–°–°–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê –° –£–õ–£–ß–®–ï–ù–ù–û–ô –ó–ê–©–ò–¢–û–ô –û–¢ RACE CONDITIONS"
        echo "üõ°Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∏ —É–≤–µ–ª–∏—á–µ–Ω—ã –¥–æ 30-120 —Å–µ–∫—É–Ω–¥"
        echo "üîÑ Retry –ø–æ–ø—ã—Ç–∫–∏ —É–≤–µ–ª–∏—á–µ–Ω—ã –¥–æ 10"
        echo "üéØ Fail-fast –æ—Ç–∫–ª—é—á—ë–Ω - –≤—Å–µ –ø–æ—Ç–æ–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ"
        echo ""
        echo "üöÄ ALPHA-STRIKE –ì–û–¢–û–í –ö –î–û–ú–ò–ù–ò–†–û–í–ê–ù–ò–Æ!" 