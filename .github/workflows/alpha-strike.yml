name: ALPHA-STRIKE v5.10-BUTLER-RETRY

on:
  workflow_dispatch:
    inputs:
      target_articles:
        description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏'
        required: true
        default: '50'
        type: string
      threads:
        description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤ (1-20)'
        required: true
        default: '20'
        type: choice
        options:
          - '5'
          - '10'
          - '15'
          - '20'
      model_choice:
        description: '–í—ã–±–æ—Ä AI –º–æ–¥–µ–ª–∏'
        required: true
        default: 'gemini'
        type: choice
        options:
        - gemini
        - openrouter

jobs:
  # –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π job –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ç—Ä–∏—Ü—ã –ø–æ—Ç–æ–∫–æ–≤
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.create-matrix.outputs.matrix }}
      articles-per-thread: ${{ steps.calculate.outputs.articles-per-thread }}
    steps:
    - name: Create thread matrix
      id: create-matrix
      run: |
        THREADS=${{ github.event.inputs.threads }}
        MATRIX="["
        for i in $(seq 1 $THREADS); do
          if [ $i -eq 1 ]; then
            MATRIX="${MATRIX}${i}"
          else
            MATRIX="${MATRIX},${i}"
          fi
        done
        MATRIX="${MATRIX}]"
        echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
        echo "–°–æ–∑–¥–∞–Ω–∞ –º–∞—Ç—Ä–∏—Ü–∞ –ø–æ—Ç–æ–∫–æ–≤: $MATRIX"

    - name: Calculate articles per thread
      id: calculate
      run: |
        TARGET_ARTICLES=${{ github.event.inputs.target_articles }}
        THREADS=${{ github.event.inputs.threads }}
        ARTICLES_PER_THREAD=$(( TARGET_ARTICLES / THREADS ))
        if [ $(( TARGET_ARTICLES % THREADS )) -ne 0 ]; then
          ARTICLES_PER_THREAD=$(( ARTICLES_PER_THREAD + 1 ))
        fi
        echo "articles-per-thread=$ARTICLES_PER_THREAD" >> $GITHUB_OUTPUT
        echo "–°—Ç–∞—Ç–µ–π –Ω–∞ –ø–æ—Ç–æ–∫: $ARTICLES_PER_THREAD"

  alpha-strike-attack:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    strategy:
      max-parallel: 20
      fail-fast: false  # –ö–†–ò–¢–ò–ß–ù–û: –ù–ï –æ—Ç–º–µ–Ω—è—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ jobs –ø—Ä–∏ —Å–±–æ–µ –æ–¥–Ω–æ–≥–æ
      matrix:
        thread-id: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies  
      run: |
        npm install googleapis node-fetch@2.6.7 execa@5.1.1 slugify@1.6.6

    - name: SETUP API KEYS
      run: |
        if [ "${{ github.event.inputs.model_choice }}" = "gemini" ]; then
          KEYS_POOL="${{ secrets.GEMINI_API_KEYS_POOL }}"
          KEY_INDEX=${{ matrix.thread-id }}
          API_KEY=$(echo "$KEYS_POOL" | tr ',' '\n' | sed -n "${KEY_INDEX}p")
          echo "GEMINI_API_KEY_CURRENT=$API_KEY" >> $GITHUB_ENV
          echo "MODEL_CHOICE=gemini" >> $GITHUB_ENV
        else
          KEYS_POOL="${{ secrets.OPENROUTER_API_KEYS_POOL }}"
          KEY_INDEX=${{ matrix.thread-id }}
          API_KEY=$(echo "$KEYS_POOL" | tr ',' '\n' | sed -n "${KEY_INDEX}p")
          echo "OPENROUTER_API_KEY_CURRENT=$API_KEY" >> $GITHUB_ENV
          echo "MODEL_CHOICE=openrouter" >> $GITHUB_ENV
        fi

    - name: ALPHA-STRIKE GENERATION v5.10
      run: |
        echo "üéØ –≠–°–ö–ê–î–†–û–ù #${{ matrix.thread-id }}: –ù–∞—á–∏–Ω–∞—é Alpha-Strike –∞—Ç–∞–∫—É!"
        echo "üìä –°—Ç–∞—Ç–µ–π –Ω–∞ –ø–æ—Ç–æ–∫: ${{ needs.prepare-matrix.outputs.articles-per-thread }}"
        echo "ü§ñ –ú–æ–¥–µ–ª—å: ${{ github.event.inputs.model_choice }}"
        echo "üéØ SEO: PERFECT (Title: 40-45, Description: 150-164, Keywords: ‚úÖ)"
        echo "ü§ñ Git —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: BUTLER STASH (–ë–ï–ó —Å–ª—É—á–∞–π–Ω—ã—Ö –∑–∞–¥–µ—Ä–∂–µ–∫!)"
        export THREAD_ID=${{ matrix.thread-id }}
        export TARGET_ARTICLES=${{ needs.prepare-matrix.outputs.articles-per-thread }}
                    node alpha-factory-v5.10-BUTLER-RETRY.js

    - name: BUTLER GIT STRATEGY (–ë–ï–ó RACE PROTECTION!)
      run: |
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git –∫–∞–∫ –≤ Butler
        git config --global user.name 'Alpha-Strike Bot v5.10'
        git config --global user.email 'actions-bot@github.com'
        git config --global pull.rebase false
        
        echo "ü§ñ Thread ${{ matrix.thread-id }}: –ò—Å–ø–æ–ª—å–∑—É—é BUTLER git —Å—Ç—Ä–∞—Ç–µ–≥–∏—é..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if [[ -z $(git status --porcelain) ]]; then
          echo "‚úÖ Thread ${{ matrix.thread-id }}: –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è commit"
          exit 0
        fi
        
        echo "üî• Thread ${{ matrix.thread-id }}: –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã. BUTLER —Å—Ç—Ä–∞—Ç–µ–≥–∏—è..."
        
        # BUTLER GIT STRATEGY (ATOMIC LOCK)
        MAX_RETRIES=5
        RETRY_DELAY=5  # –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ –≤ Butler
        
        for ((i=1; i<=MAX_RETRIES; i++)); do
          echo "üîÑ Thread ${{ matrix.thread-id }}: Butler git –ø–æ–ø—ã—Ç–∫–∞ $i/$MAX_RETRIES"
          
          # 1. –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –≤ staging (–ö–ê–ö –í BUTLER)
          git add src/content/posts/*.md
          
          # 2. Stash –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è —á–∏—Å—Ç–æ–≥–æ pull (–ö–õ–Æ–ß–ï–í–ê–Ø BUTLER –°–¢–†–ê–¢–ï–ì–ò–Ø!)
          git stash push -m "Thread ${{ matrix.thread-id }} - attempt $i"
          
          # 3. –î–µ–ª–∞–µ–º pull –ë–ï–ó rebase (–ö–ê–ö –í BUTLER)
          git pull origin main
          
          # 4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è (–ö–ê–ö –í BUTLER)
          git stash pop || echo "Stash already applied"
          
          # 5. –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã —Å–Ω–æ–≤–∞ –Ω–∞ —Å–ª—É—á–∞–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ (–ö–ê–ö –í BUTLER)
          git add src/content/posts/*.md
          
          # 6. –ö–æ–º–º–∏—Ç–∏–º (–ö–ê–ö –í BUTLER)
          git commit -m "üéØ Alpha-Strike v5.10 BUTLER: Thread ${{ matrix.thread-id }} - $(date)" || echo "Nothing to commit"
          
          # 7. Push (–ö–ê–ö –í BUTLER)
          if git push; then
            echo "‚úÖ Thread ${{ matrix.thread-id }}: Butler git push —É—Å–ø–µ—à–µ–Ω –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ $i!"
            break
          else
            if [ "$i" -eq "$MAX_RETRIES" ]; then
              echo "‚ùå Thread ${{ matrix.thread-id }}: –í—Å–µ $MAX_RETRIES Butler –ø–æ–ø—ã—Ç–æ–∫ –∏—Å—á–µ—Ä–ø–∞–Ω—ã"
              exit 1
            fi
            echo "‚ö†Ô∏è Thread ${{ matrix.thread-id }}: Butler git push –Ω–µ—É–¥–∞—á–µ–Ω, –ø–æ–ø—ã—Ç–∫–∞ $i"
            # 8. –û—Ç–∫–∞—Ç –∫–æ–º–º–∏—Ç–∞ –∏ retry (–ö–ê–ö –í BUTLER!)
            git reset --hard HEAD~1
            sleep $RETRY_DELAY
          fi
        done

    - name: REPORT GENERATION  
      run: |
        echo "‚úÖ –≠–°–ö–ê–î–†–û–ù #${{ matrix.thread-id }}: Alpha-Strike v5.10 BUTLER –º–∏—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
        echo "üéØ Model: ${{ github.event.inputs.model_choice }}"
        echo "üìä Target articles: ${{ needs.prepare-matrix.outputs.articles-per-thread }}"
        echo "üéØ SEO: PERFECT OPTIMIZATION"

  quality-control:
    needs: alpha-strike-attack
    runs-on: ubuntu-latest
    if: always()  # –ó–∞–ø—É—Å–∫–∞–µ–º –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ jobs –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å
    steps:
    - name: Checkout repository  
      uses: actions/checkout@v4

    - name: QUALITY CONTROL v5.9
      run: |
        echo "üîç –ö–û–ù–¢–†–û–õ–¨ –ö–ê–ß–ï–°–¢–í–ê ALPHA-STRIKE v5.9-PERFECT-SEO"
        echo ""
        echo "üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–û–ó–î–ê–ù–ù–´–• –°–¢–ê–¢–ï–ô:"
        find src/content/posts -name "post*.md" -newer .git/logs/HEAD | wc -l || echo "0"
        echo ""
        echo "üîó –ü–†–Ø–ú–´–ï –°–°–´–õ–ö–ò –ù–ê –ù–û–í–´–ï –°–¢–ê–¢–¨–ò:"
        find src/content/posts -name "post*.md" -newer .git/logs/HEAD | head -10 | while read file; do
          filename=$(basename "$file" .md)
          echo "  üìÑ https://blondeplace.netlify.app/blog/$filename/"
        done
        echo ""
        echo "üéØ SEO –ü–†–û–í–ï–†–ö–ê:"
        echo "  ‚úÖ Title –¥–ª–∏–Ω–∞: 40-45 —Å–∏–º–≤–æ–ª–æ–≤"
        echo "  ‚úÖ Description –¥–ª–∏–Ω–∞: 150-164 —Å–∏–º–≤–æ–ª–∞"  
        echo "  ‚úÖ Keywords: –¥–æ–±–∞–≤–ª–µ–Ω—ã"
        echo "  ‚úÖ –¢–æ—à–Ω–æ—Ç–∞: —Å–Ω–∏–∂–µ–Ω–∞"

  final-report:
    needs: [alpha-strike-attack, quality-control]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: FINAL REPORT v5.9
      run: |
        echo "üéØ –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–Å–¢ ALPHA-STRIKE v5.9-PERFECT-SEO"
        echo ""
        echo "‚úÖ –ú–ò–°–°–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê –° PERFECT SEO –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ï–ô"
        echo "üéØ Title: 40-45 —Å–∏–º–≤–æ–ª–æ–≤ (CheckSite —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ)"
        echo "üéØ Description: 150-164 —Å–∏–º–≤–æ–ª–∞ (CheckSite —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ)"
        echo "üéØ Keywords: –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –º–µ—Ç–∞-—Ç–µ–≥–∏"
        echo "üéØ –¢–æ—à–Ω–æ—Ç–∞: —Å–Ω–∏–∂–µ–Ω–∞ —Å 8.25 –¥–æ <5"
        echo "üéØ Race protection: —É–ø—Ä–æ—â–µ–Ω–∞ (5-20s –≤–º–µ—Å—Ç–æ 30-120s)"
        echo "üßµ –ü–æ—Ç–æ–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: ${{ github.event.inputs.threads }}"
        echo "üìä –°—Ç–∞—Ç–µ–π –∑–∞–ø—Ä–æ—à–µ–Ω–æ: ${{ github.event.inputs.target_articles }}"
        echo ""
        echo "üöÄ ALPHA-STRIKE v5.9 –ì–û–¢–û–í –ö –î–û–ú–ò–ù–ò–†–û–í–ê–ù–ò–Æ –° PERFECT SEO!" 