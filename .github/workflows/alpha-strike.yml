name: üöÄüí• –ü–õ–ê–ù "–ê–õ–¨–§–ê-–£–î–ê–†" - –ë–û–ï–í–ê–Ø –û–ü–ï–†–ê–¶–ò–Ø

on:
  workflow_dispatch:
    inputs:
      target_articles:
        description: '–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5000)'
        required: false
        default: '5000'
      threads:
        description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20)'
        required: false
        default: '20'
      model_choice:
        description: '–ú–æ–¥–µ–ª—å AI (gemini/deepseek)'
        required: false
        default: 'gemini'
        type: choice
        options:
        - gemini
        - deepseek

env:
  NODE_VERSION: '18'

jobs:
  alpha-strike-preparation:
    name: üéØ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –±–æ–µ–≤–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
    runs-on: ubuntu-latest
    outputs:
      articles-per-thread: ${{ steps.calc.outputs.articles-per-thread }}
      thread-matrix: ${{ steps.calc.outputs.thread-matrix }}
    
    steps:
    - name: üìä –†–∞—Å—á–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∞—Ç–∞–∫–∏
      id: calc
      run: |
        TOTAL_ARTICLES=${{ github.event.inputs.target_articles || '5000' }}
        TOTAL_THREADS=${{ github.event.inputs.threads || '20' }}
        
        ARTICLES_PER_THREAD=$((TOTAL_ARTICLES / TOTAL_THREADS))
        
        echo "articles-per-thread=$ARTICLES_PER_THREAD" >> $GITHUB_OUTPUT
        
        # –°–æ–∑–¥–∞–µ–º –º–∞—Ç—Ä–∏—Ü—É –ø–æ—Ç–æ–∫–æ–≤
        THREAD_ARRAY="["
        for i in $(seq 1 $TOTAL_THREADS); do
          if [ $i -gt 1 ]; then
            THREAD_ARRAY="$THREAD_ARRAY,"
          fi
          THREAD_ARRAY="$THREAD_ARRAY$i"
        done
        THREAD_ARRAY="$THREAD_ARRAY]"
        
        echo "thread-matrix=$THREAD_ARRAY" >> $GITHUB_OUTPUT
        
        echo "üéØ –ü–õ–ê–ù –ê–õ–¨–§–ê-–£–î–ê–† –ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–ù:"
        echo "üìä –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π: $TOTAL_ARTICLES"
        echo "‚ö° –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤: $TOTAL_THREADS" 
        echo "üìù –°—Ç–∞—Ç–µ–π –Ω–∞ –ø–æ—Ç–æ–∫: $ARTICLES_PER_THREAD"
        echo "üîó –û–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Å—ã–ª–æ–∫: $((TOTAL_ARTICLES * 85))"

  alpha-strike-attack:
    name: üí• –ë–æ–µ–≤–æ–π –ø–æ—Ç–æ–∫ #${{ matrix.thread-id }}
    runs-on: ubuntu-latest
    needs: alpha-strike-preparation
    
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix:
        thread-id: ${{ fromJson(needs.alpha-strike-preparation.outputs.thread-matrix) }}
    
    steps:
    - name: üîÑ Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ‚ö° –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        npm ci
        echo "üîß –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –ø–æ—Ç–æ–∫–∞ #${{ matrix.thread-id }}"

    - name: üöÄüí• –ó–ê–ü–£–°–ö –ê–õ–¨–§–ê-–£–î–ê–†–ê #${{ matrix.thread-id }}
      env:
        THREAD_ID: ${{ matrix.thread-id }}
        ALPHA_ARTICLES: ${{ needs.alpha-strike-preparation.outputs.articles-per-thread }}
        MODEL_CHOICE: ${{ github.event.inputs.model_choice || 'gemini' }}
        API_KEY_CURRENT: ${{ secrets.GEMINI_API_KEY_1 }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        echo "üöÄüí• [–ü–û–¢–û–ö #${{ matrix.thread-id }}] –ù–ê–ß–ê–õ–û –ë–û–ï–í–û–ô –û–ü–ï–†–ê–¶–ò–ò"
        echo "üéØ –¶–µ–ª—å: ${{ needs.alpha-strike-preparation.outputs.articles-per-thread }} —Å—Ç–∞—Ç–µ–π"
        echo "ü§ñ –ú–æ–¥–µ–ª—å: ${{ github.event.inputs.model_choice || 'gemini' }}"
        echo "üîë API –∫–ª—é—á: ...$(echo $API_KEY_CURRENT | tail -c 5)"
        
        # –ó–∞–ø—É—Å–∫ –±–æ–µ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
        node alpha-factory.js
        
        echo "‚úÖ [–ü–û–¢–û–ö #${{ matrix.thread-id }}] –ú–ò–°–°–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê"

    - name: üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Ç–æ–∫–∞ #${{ matrix.thread-id }}
      run: |
        echo "üìà –û–¢–ß–ï–¢ –ü–û –ü–û–¢–û–ö–£ #${{ matrix.thread-id }}:"
        
        # –ü–æ–¥—Å—á–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        CREATED_FILES=$(find src/content/posts -name "*.md" | wc -l)
        echo "üìù –°–æ–∑–¥–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: $CREATED_FILES"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—å–∏:"
        ls -la src/content/posts/*.md | tail -5 || echo "–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

  alpha-strike-deploy:
    name: üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞—Ç–∞–∫–∏
    runs-on: ubuntu-latest
    needs: [alpha-strike-preparation, alpha-strike-attack]
    
    steps:
    - name: üîÑ Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: üìä –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
      run: |
        echo "üèÜ –ü–õ–ê–ù '–ê–õ–¨–§–ê-–£–î–ê–†' –ó–ê–í–ï–†–®–ï–ù!"
        echo "================================"
        
        # –ü–æ–¥—Å—á–µ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–∞–π–ª–æ–≤
        TOTAL_FILES=$(find src/content/posts -name "*.md" 2>/dev/null | wc -l)
        echo "üìù –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π: $TOTAL_FILES"
        
        # –†–∞—Å—á–µ—Ç —Å—Å—ã–ª–æ–∫
        EXPECTED_LINKS=$((TOTAL_FILES * 85))
        echo "üîó –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Å—ã–ª–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∞–π—Ç: $EXPECTED_LINKS"
        
        echo "üéØ –¶–µ–ª–µ–≤–æ–π —Å–∞–π—Ç –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è: https://blondeplace.ru"
        echo "üì° –°–∞–π—Ç-—Å–∞—Ç–µ–ª–ª–∏—Ç: https://blondeplace.netlify.app"
        
        # –†–∞–∑–º–µ—Ä —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        REPO_SIZE=$(du -sh . 2>/dev/null | cut -f1)
        echo "üíæ –†–∞–∑–º–µ—Ä —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: $REPO_SIZE"
        
        echo "================================"
        echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ø–æ–∑–∏—Ü–∏–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∞–π—Ç–∞ blondeplace.ru"
        echo "üìà –û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç: 4-7 –¥–Ω–µ–π"
        echo "üî• –°—Ç–∞—Ç—É—Å —Å–∞—Ç–µ–ª–ª–∏—Ç–∞: –†–∞—Å—Ö–æ–¥–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª (–º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)"

    - name: üéâ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
      run: |
        echo "üéä –û–ü–ï–†–ê–¶–ò–Ø '–ê–õ–¨–§–ê-–£–î–ê–†' –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê!"
        echo "üöÄ –í—Å–µ ${{ github.event.inputs.target_articles || '5000' }} —Å—Ç–∞—Ç–µ–π —Å–æ–∑–¥–∞–Ω—ã"
        echo "‚ö° ${{ github.event.inputs.threads || '20' }} –ø–æ—Ç–æ–∫–æ–≤ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ"
        echo "üéØ –ù–∞—á–∏–Ω–∞–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–∑–∏—Ü–∏–π blondeplace.ru –ø–æ –∫–ª—é—á–µ–≤—ã–º —Ñ—Ä–∞–∑–∞–º" 