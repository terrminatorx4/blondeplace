name: ğŸš€ Alpha-Strike v5.27 - TRUE PARALLEL MATRIX
on:
  workflow_dispatch:
    inputs:
      model:
        description: 'ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ˜Ğ˜ (gemini/openrouter)'
        required: true
        default: 'gemini'
        type: choice
        options:
          - gemini
          - openrouter
      threads:
        description: 'ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ² (1-20)'
        required: true
        default: '20'
        type: string
      articles_per_thread:
        description: 'Ğ¡Ñ‚Ğ°Ñ‚ĞµĞ¹ Ğ½Ğ° Ğ¿Ğ¾Ñ‚Ğ¾Ğº (1-10)'
        required: true
        default: '1'
        type: string

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - name: ğŸ“Š Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒÑ Matrix Ğ´Ğ»Ñ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ²
      id: set-matrix
      run: |
        threads=${{ github.event.inputs.threads }}
        matrix="["
        for i in $(seq 1 $threads); do
          if [ $i -eq $threads ]; then
            matrix="${matrix}${i}"
          else
            matrix="${matrix}${i},"
          fi
        done
        matrix="${matrix}]"
        echo "matrix={\"thread\":[${matrix:1:-1}]}" >> $GITHUB_OUTPUT
        echo "Generated matrix: {\"thread\":[${matrix:1:-1}]}"

  alpha-strike-attack:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix: ${{fromJson(needs.prepare-matrix.outputs.matrix)}}
      fail-fast: false
      max-parallel: 20
    
    steps:
    - name: ğŸ”„ Force Cache Clean Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        clean: true
        
    - name: ğŸ§¹ Clear All Caches - Thread ${{ matrix.thread }}
      run: |
        echo "ğŸš¨ ĞŸĞĞ¢ĞĞš #${{ matrix.thread }}: ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ĞºÑÑˆĞµĞ¹!"
        rm -rf node_modules/.cache || true
        rm -rf .next/cache || true
        rm -rf .astro/cache || true
        echo "âœ… ĞšÑÑˆĞ¸ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ñ‹ Ğ´Ğ»Ñ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ° #${{ matrix.thread }}"
        
    - name: âš¡ Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        echo "ğŸ”„ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°Ñ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ° #${{ matrix.thread }}..."
        npm ci --no-cache
        
    - name: ğŸ” Verify Alpha-Factory Version - Thread ${{ matrix.thread }}
      run: |
        echo "ğŸ” ĞŸĞĞ¢ĞĞš #${{ matrix.thread }}: ĞŸĞ ĞĞ’Ğ•Ğ Ğ¯Ğ® Ğ’Ğ•Ğ Ğ¡Ğ˜Ğ® ALPHA-FACTORY:"
        head -3 alpha-factory-v5.10-BUTLER-RETRY.js
        echo ""
        echo "ğŸ” ĞŸĞĞ¢ĞĞš #${{ matrix.thread }}: ĞŸĞ ĞĞ’Ğ•Ğ Ğ¯Ğ® baseNumber = 200000:"
        grep -n "baseNumber.*200000" alpha-factory-v5.10-BUTLER-RETRY.js || echo "âŒ ĞĞ• ĞĞĞ™Ğ”Ğ•Ğ!"
        
    - name: ğŸš€ Alpha-Strike Thread ${{ matrix.thread }} - FORCE v5.27
      env:
        GEMINI_API_KEYS_POOL: ${{ secrets.GEMINI_API_KEYS_POOL }}
        OPENROUTER_API_KEYS_POOL: ${{ secrets.OPENROUTER_API_KEYS_POOL }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸš€ ĞŸĞĞ¢ĞĞš #${{ matrix.thread }}: Ğ—ĞĞŸĞ£Ğ¡Ğš ALPHA-STRIKE v5.27!"
        echo "ğŸ¤– ĞœĞ¾Ğ´ĞµĞ»ÑŒ: ${{ github.event.inputs.model }}"
        echo "ğŸ“Š ĞŸĞ¾Ñ‚Ğ¾Ğº: ${{ matrix.thread }}"
        echo "ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ĞµĞ¹ Ğ½Ğ° Ğ¿Ğ¾Ñ‚Ğ¾Ğº: ${{ github.event.inputs.articles_per_thread }}"
        echo "ğŸ¯ ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€: 20${{ matrix.thread }}00"
        echo ""
        node alpha-factory-v5.10-BUTLER-RETRY.js \
          --model ${{ github.event.inputs.model }} \
          --threads 1 \
          --articles ${{ github.event.inputs.articles_per_thread }} \
          --thread-id ${{ matrix.thread }}
          
    - name: ğŸ“Š Thread ${{ matrix.thread }} Status
      run: |
        echo "âœ… ĞŸĞĞ¢ĞĞš #${{ matrix.thread }}: Alpha-Strike v5.27 Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½!"
        echo "ğŸ¯ ĞĞ¾Ğ¼ĞµÑ€ Ğ¿Ğ¾ÑÑ‚Ğ°: post20${{ matrix.thread }}00"

  quality-control:
    needs: alpha-strike-attack
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: ğŸ“Š ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚
      run: |
        echo "âœ… Ğ’Ğ¡Ğ• ĞŸĞĞ¢ĞĞšĞ˜ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ«!"
        echo "ğŸ¯ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¾ ÑÑ‚Ğ°Ñ‚ĞµĞ¹: ${{ github.event.inputs.threads }}"
        echo "ğŸ¯ ĞĞ¾Ğ¼ĞµÑ€Ğ°: post200100 - post20${{ github.event.inputs.threads }}00"
        echo "ğŸ¯ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ sitemap Ğ½Ğ° Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑÑÑ‹Ğ»ĞºĞ¸!"

  final-report:
    needs: [alpha-strike-attack, quality-control]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: ğŸ‰ Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚
      run: |
        echo "ğŸ‰ ALPHA-STRIKE v5.27 MATRIX Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•Ğ!"
        echo "ğŸ“Š Ğ˜ÑÑ‚Ğ¸Ğ½Ğ½Ğ°Ñ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ: ${{ github.event.inputs.threads }} jobs"
        echo "ğŸ“Š baseNumber = 200000 - ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ°"
        echo "ğŸ“Š Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ: Ğ² ${{ github.event.inputs.threads }}x Ñ€Ğ°Ğ· Ğ±Ñ‹ÑÑ‚Ñ€ĞµĞµ!" 