---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

const post = Astro.props;
const { Content } = await post.render();

// Получаем связанные статьи (из той же категории)
const allPosts = await getCollection('posts');
const relatedPosts = allPosts
  .filter(p => p.data.category === post.data.category && p.slug !== post.slug)
  .sort((a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf())
  .slice(0, 3);

// Функция для получения названия категории
function getCategoryName(category) {
  const categoryNames = {
    'hair-care': 'Уход за волосами',
    'hair-coloring': 'Окрашивание волос', 
    'hairstyles': 'Прически',
    'blonde-trends': 'Тренды блонда',
    'hair-treatments': 'Процедуры для волос',
    'nail-care': 'Уход за ногтями',
    'manicure': 'Маникюр',
    'pedicure': 'Педикюр',
    'skincare': 'Уход за кожей',
    'makeup': 'Макияж',
    'beauty-tips': 'Beauty советы',
    'salon-news': 'Новости салона',
    'hair-products': 'Продукты для волос',
    'beauty-trends': 'Тренды красоты',
    'seasonal-beauty': 'Сезонная красота'
  };
  return categoryNames[category] || category;
}
---

<Layout 
  title={post.data.title} 
  description={post.data.description}
  keywords={post.data.keywords}
  heroImage={post.data.heroImage}
  schema={post.data.schema}
>
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(post.data.schema)} />

  <article class="container">
    <!-- Breadcrumbs -->
    <nav class="breadcrumbs">
      <a href="/">Главная</a>
      <span class="separator">→</span>
      <a href="/blog">Блог</a>
      <span class="separator">→</span>
      <a href={`/blog?category=${post.data.category}`}>
        {getCategoryName(post.data.category)}
      </a>
      <span class="separator">→</span>
      <span class="current">{post.data.title}</span>
    </nav>

    <!-- Article Header -->
    <header class="article-header">
      <div class="article-meta">
        <span class="category-tag">{getCategoryName(post.data.category)}</span>
        <time class="publish-date" datetime={post.data.pubDate.toISOString()}>
          {new Date(post.data.pubDate).toLocaleDateString('ru-RU', {
            year: 'numeric',
            month: 'long', 
            day: 'numeric'
          })}
        </time>
      </div>
      
      <h1 class="article-title">{post.data.title}</h1>
      
      <p class="article-description">{post.data.description}</p>
      
      <div class="author-info">
        <span class="author-name">by {post.data.author}</span>
        <span class="read-time">☕ 5-7 мин чтения</span>
      </div>
    </header>

    <!-- Hero Image -->
    {post.data.heroImage && (
      <div class="article-image">
        <img src={post.data.heroImage} alt={post.data.title} />
      </div>
    )}

    <!-- Article Content -->
    <div class="article-content">
      <Content />
    </div>

    <!-- Article Footer -->
    <footer class="article-footer">
      <div class="tags-section">
        <h3>Теги статьи:</h3>
        <div class="tags">
          <span class="tag">{getCategoryName(post.data.category)}</span>
          {post.data.keywords && post.data.keywords.split(',').slice(0, 3).map(keyword => (
            <span class="tag">{keyword.trim()}</span>
          ))}
        </div>
      </div>
      
      <div class="share-section">
        <h3>Поделиться статьей:</h3>
        <div class="share-buttons">
          <a href={`https://vk.com/share.php?url=${Astro.url}`} target="_blank" class="share-btn vk">
            VK
          </a>
          <a href={`https://t.me/share/url?url=${Astro.url}&text=${post.data.title}`} target="_blank" class="share-btn telegram">
            Telegram
          </a>
          <a href={`https://wa.me/?text=${post.data.title} ${Astro.url}`} target="_blank" class="share-btn whatsapp">
            WhatsApp
          </a>
        </div>
      </div>
    </footer>

    <!-- CTA Section -->
    <section class="article-cta">
      <div class="cta-content">
        <h2>Понравилась статья?</h2>
        <p>Записывайтесь на консультацию к нашим мастерам в салон BlondePlace и получите персональные рекомендации</p>
        <div class="cta-buttons">
          <a href="https://blondeplace.ru" class="cta-primary" target="_blank">
            Записаться в салон
          </a>
          <a href="/blog" class="cta-secondary">
            Читать другие статьи
          </a>
        </div>
      </div>
    </section>

    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <section class="related-posts">
        <h2 class="related-title">Похожие статьи</h2>
        <div class="related-grid">
          {relatedPosts.map((relatedPost) => (
            <article class="related-card">
              <div class="related-image">
                {relatedPost.data.heroImage ? (
                  <img src={relatedPost.data.heroImage} alt={relatedPost.data.title} loading="lazy" />
                ) : (
                  <div class="related-placeholder">
                    <span>{getCategoryName(relatedPost.data.category)}</span>
                  </div>
                )}
              </div>
              <div class="related-content">
                <h3 class="related-post-title">
                  <a href={`/blog/${relatedPost.slug}/`}>{relatedPost.data.title}</a>
                </h3>
                <p class="related-excerpt">{relatedPost.data.description}</p>
                <time class="related-date">
                  {new Date(relatedPost.data.pubDate).toLocaleDateString('ru-RU', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                  })}
                </time>
              </div>
            </article>
          ))}
        </div>
      </section>
    )}
  </article>

  <style>
    /* === BREADCRUMBS === */
    .breadcrumbs {
      padding: 1rem 0;
      font-size: 0.9rem;
      color: var(--elegant-gray);
      margin-bottom: 2rem;
    }

    .breadcrumbs a {
      color: var(--beauty-pink);
      text-decoration: none;
    }

    .breadcrumbs a:hover {
      text-decoration: underline;
    }

    .separator {
      margin: 0 0.5rem;
    }

    .current {
      color: var(--soft-black);
      font-weight: 500;
    }

    /* === ARTICLE HEADER === */
    .article-header {
      margin-bottom: 3rem;
      text-align: center;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    .article-meta {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .category-tag {
      background: var(--beauty-pink);
      color: var(--pure-white);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .publish-date {
      color: var(--elegant-gray);
      font-size: 0.9rem;
    }

    .article-title {
      font-family: var(--font-heading);
      font-size: 3rem;
      line-height: 1.2;
      color: var(--soft-black);
      margin-bottom: 1.5rem;
    }

    .article-description {
      font-size: 1.3rem;
      color: var(--elegant-gray);
      line-height: 1.6;
      margin-bottom: 1.5rem;
    }

    .author-info {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      color: var(--elegant-gray);
      font-size: 0.9rem;
    }

    .author-name {
      font-weight: 600;
    }

    /* === ARTICLE IMAGE === */
    .article-image {
      margin-bottom: 3rem;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .article-image img {
      width: 100%;
      height: 400px;
      object-fit: cover;
    }

    /* === ARTICLE CONTENT === */
    .article-content {
      max-width: 800px;
      margin: 0 auto 4rem;
      line-height: 1.8;
      font-size: 1.1rem;
    }

    .article-content h2 {
      font-family: var(--font-heading);
      font-size: 2rem;
      color: var(--soft-black);
      margin: 3rem 0 1.5rem;
      border-bottom: 3px solid var(--beauty-pink);
      padding-bottom: 0.5rem;
    }

    .article-content h3 {
      font-family: var(--font-heading);
      font-size: 1.5rem;
      color: var(--soft-black);
      margin: 2.5rem 0 1rem;
    }

    .article-content p {
      margin-bottom: 1.5rem;
      color: var(--soft-black);
    }

    .article-content ul, .article-content ol {
      margin-bottom: 1.5rem;
      padding-left: 2rem;
    }

    .article-content li {
      margin-bottom: 0.5rem;
    }

    .article-content blockquote {
      background: var(--warm-beige);
      border-left: 4px solid var(--beauty-pink);
      padding: 1.5rem;
      margin: 2rem 0;
      border-radius: 0 10px 10px 0;
      font-style: italic;
    }

    .article-content strong {
      color: var(--beauty-pink);
      font-weight: 600;
    }

    /* === ARTICLE FOOTER === */
    .article-footer {
      border-top: 1px solid var(--warm-beige);
      padding: 2rem 0;
      margin-bottom: 3rem;
    }

    .tags-section, .share-section {
      margin-bottom: 2rem;
    }

    .tags-section h3, .share-section h3 {
      font-family: var(--font-heading);
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: var(--soft-black);
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .tag {
      background: var(--warm-beige);
      color: var(--soft-black);
      padding: 0.3rem 0.8rem;
      border-radius: 12px;
      font-size: 0.9rem;
      border: 1px solid var(--beauty-pink);
    }

    .share-buttons {
      display: flex;
      gap: 1rem;
    }

    .share-btn {
      padding: 0.7rem 1.5rem;
      border-radius: 20px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      color: var(--pure-white);
    }

    .share-btn.vk { background: #4680C2; }
    .share-btn.telegram { background: #0088CC; }
    .share-btn.whatsapp { background: #25D366; }

    .share-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    /* === CTA SECTION === */
    .article-cta {
      background: linear-gradient(135deg, var(--beauty-pink), var(--salon-purple));
      padding: 3rem 2rem;
      border-radius: 20px;
      text-align: center;
      margin-bottom: 4rem;
    }

    .cta-content h2 {
      font-family: var(--font-heading);
      font-size: 2.2rem;
      color: var(--pure-white);
      margin-bottom: 1rem;
    }

    .cta-content p {
      font-size: 1.1rem;
      color: rgba(255,255,255,0.9);
      margin-bottom: 2rem;
    }

    .cta-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .cta-primary, .cta-secondary {
      padding: 1rem 2rem;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .cta-primary {
      background: var(--pure-white);
      color: var(--soft-black);
    }

    .cta-secondary {
      background: transparent;
      color: var(--pure-white);
      border: 2px solid var(--pure-white);
    }

    .cta-primary:hover, .cta-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    /* === RELATED POSTS === */
    .related-posts {
      margin-bottom: 4rem;
    }

    .related-title {
      font-family: var(--font-heading);
      font-size: 2rem;
      text-align: center;
      margin-bottom: 2rem;
      color: var(--soft-black);
    }

    .related-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
    }

    .related-card {
      background: var(--pure-white);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 20px rgba(0,0,0,0.05);
      transition: transform 0.3s ease;
    }

    .related-card:hover {
      transform: translateY(-5px);
    }

    .related-image {
      height: 150px;
      overflow: hidden;
      background: var(--warm-beige);
    }

    .related-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .related-placeholder {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--blonde-gold), var(--beauty-pink));
      color: var(--pure-white);
      font-weight: 600;
    }

    .related-content {
      padding: 1.5rem;
    }

    .related-post-title a {
      font-family: var(--font-heading);
      font-size: 1.2rem;
      color: var(--soft-black);
      text-decoration: none;
      line-height: 1.3;
    }

    .related-post-title a:hover {
      color: var(--beauty-pink);
    }

    .related-excerpt {
      color: var(--elegant-gray);
      font-size: 0.9rem;
      margin: 0.5rem 0;
      line-height: 1.5;
    }

    .related-date {
      font-size: 0.8rem;
      color: var(--elegant-gray);
    }

    /* === RESPONSIVE === */
    @media (max-width: 768px) {
      .article-title {
        font-size: 2.2rem;
      }

      .article-description {
        font-size: 1.1rem;
      }

      .article-meta {
        flex-direction: column;
        gap: 0.5rem;
      }

      .author-info {
        flex-direction: column;
        gap: 0.5rem;
      }

      .article-image img {
        height: 250px;
      }

      .article-content {
        font-size: 1rem;
      }

      .cta-buttons {
        flex-direction: column;
        align-items: center;
      }

      .share-buttons {
        flex-wrap: wrap;
        justify-content: center;
      }

      .related-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</Layout>
