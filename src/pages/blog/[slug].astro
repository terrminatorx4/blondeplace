---
import fs from "fs";
import path from "path";

// СТТСЯ Я СХ СТТ
export async function getStaticPaths() {
  const postsDir = path.join(process.cwd(), "src/content/posts");
  
  try {
    // итаем все файлы в папке posts
    const files = fs.readdirSync(postsDir);
    const mdFiles = files.filter(file => file.endsWith(".md"));
    
    // Создаем пути для всех статей
    const paths = mdFiles.map(file => {
      const slug = file.replace(".md", "");
      return { params: { slug } };
    });
    
    console.log(`айдено ${paths.length} статей для генерации`);
    return paths;
    
  } catch (error) {
    console.error("шибка чтения папки posts:", error);
    return [];
  }
}

const { slug } = Astro.params;

// итаем содержимое статьи
let title = `Статья ${slug}`;
let description = `писание статьи ${slug}`;
let content = "";

try {
  const filePath = path.join(process.cwd(), "src/content/posts", `${slug}.md`);
  const fileContent = fs.readFileSync(filePath, "utf-8");
  
  // ростой парсинг frontmatter
  const frontmatterMatch = fileContent.match(/^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/);
  
  if (frontmatterMatch) {
    const frontmatterLines = frontmatterMatch[1].split("\n");
    content = frontmatterMatch[2];
    
    frontmatterLines.forEach(line => {
      if (line.startsWith("title:")) {
        title = line.replace("title:", "").replace(/"/g, "").trim();
      }
      if (line.startsWith("description:")) {
        description = line.replace("description:", "").replace(/"/g, "").trim();
      }
    });
  }
} catch (error) {
  console.error(`шибка чтения файла ${slug}:`, error);
}
---

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title} | BlondePlace</title>
    <meta name="description" content={description}>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            line-height: 1.6;
        }
        h1 { color: #2c3e50; }
        .meta { color: #7f8c8d; margin-bottom: 20px; }
        .content { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 8px; 
            white-space: pre-wrap;
        }
        a { color: #3498db; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <header>
        <h1>{title}</h1>
        <div class="meta">
            <p>Статья: {slug}</p>
            <p>✅ Статья восстановлена и доступна!</p>
        </div>
    </header>
    
    <main>
        <div class="content">
            {content.substring(0, 2000)}...
        </div>
    </main>
    
    <footer>
        <p><a href="/blog/">← ернуться в блог</a></p>
        <p><a href="/">← а главную</a></p>
    </footer>
</body>
</html>