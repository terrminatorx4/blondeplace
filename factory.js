import { GoogleGenerativeAI } from '@google/generative-ai';
import fs from 'fs/promises';
import path from 'path';
import fetch from 'node-fetch';
import { execa } from 'execa';

// --- –ö–û–ù–°–¢–ê–ù–¢–´ ---
const SITE_URL = 'https://blondeplace.netlify.app';
const BRAND_NAME = 'BlondePlace';
const BRAND_BLOG_NAME = '–ë–ª–æ–≥ BlondePlace';
const BRAND_AUTHOR_NAME = '–≠–∫—Å–ø–µ—Ä—Ç BlondePlace';
const FALLBACK_IMAGE_URL = 'https://images.unsplash.com/photo-1522337360788-8b13dee7a37e?q=80&w=2069&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D';
const INDEXNOW_API_KEY = 'df39150ca56f896546628ae3c923dd4a';

// --- –ù–ê–°–¢–†–û–ô–ö–ò –û–ü–ï–†–ê–¶–ò–ò ---
const TARGET_URL_MAIN = "https://blondeplace.ru";
const TOPICS_FILE = 'topics.txt';
const POSTS_DIR = 'src/content/posts';

// --- –ù–ê–°–¢–†–û–ô–ö–ò –ú–û–î–ï–õ–ï–ô ---
const OPENROUTER_API_URL = "https://openrouter.ai/api/v1/chat/completions";
const DEEPSEEK_MODEL_NAME = "deepseek/deepseek-r1-0528:free";
const GEMINI_MODEL_NAME = "gemini-2.5-flash";

// --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û–¢–û–ö–ê ---
const modelChoice = process.env.MODEL_CHOICE || 'gemini';
const threadId = parseInt(process.env.THREAD_ID, 10) || 1;
const apiKey = process.env.API_KEY_CURRENT;

if (!apiKey) {
    throw new Error(`[–ü–æ—Ç–æ–∫ #${threadId}] –ù–µ –±—ã–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω API-–∫–ª—é—á (API_KEY_CURRENT)!`);
}

// –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ö–ê–ö –í BUTLER FACTORY
if (modelChoice === 'deepseek') {
    console.log(`üöÄ [–ü–æ—Ç–æ–∫ #${threadId}] –ò—Å–ø–æ–ª—å–∑—É—é –º–æ–¥–µ–ª—å DeepSeek —á–µ—Ä–µ–∑ OpenRouter —Å –∫–ª—é—á–æ–º ...${apiKey.slice(-4)}`);
} else {
    console.log(`‚ú® [–ü–æ—Ç–æ–∫ #${threadId}] –ò—Å–ø–æ–ª—å–∑—É—é –º–æ–¥–µ–ª—å Gemini —Å –∫–ª—é—á–æ–º ...${apiKey.slice(-4)}`);
}

function slugify(text) {
    const cleanedText = text.toString().replace(/[\x00-\x1F\x7F-\x9F]/g, "").trim();
    const from = "–∞ –± –≤ –≥ –¥ –µ —ë –∂ –∑ –∏ –π –∫ –ª –º –Ω –æ –ø —Ä —Å —Ç —É —Ñ —Ö —Ü —á —à —â —ä —ã —å —ç —é —è".split(' ');
    const to = "a b v g d e yo zh z i y k l m n o p r s t u f h c ch sh sch '' y ' e yu ya".split(' ');
    let newText = cleanedText.toLowerCase();
    for (let i = 0; i < from.length; i++) {
        newText = newText.replace(new RegExp(from[i], 'g'), to[i]);
    }
    return newText.replace(/\s+/g, '-').replace(/[^\w-]+/g, '').replace(/--+/g, '-').replace(/^-+/, '').replace(/-+$/, '');
}

// –£–õ–£–ß–®–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò –¶–ï–õ–û–°–¢–ù–û–°–¢–ò –°–õ–û–í
function ensureCompleteWords(text, minLength, maxLength) {
    // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –∫–æ—Ä–æ—á–µ –º–∏–Ω–∏–º—É–º–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
    if (text.length < minLength) return text;
    
    // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
    if (text.length <= maxLength) return text;
    
    // –û–±—Ä–µ–∑–∞–µ–º –ø–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω–µ
    let trimmed = text.slice(0, maxLength);
    
    // –ï—Å–ª–∏ —Å–ª–µ–¥—É—é—â–∏–π —Å–∏–º–≤–æ–ª –Ω–µ –ø—Ä–æ–±–µ–ª, –∏—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ–±–µ–ª
    if (text[maxLength] && text[maxLength] !== ' ') {
        const lastSpaceIndex = trimmed.lastIndexOf(' ');
        // –ù–µ –æ–±—Ä–µ–∑–∞–µ–º —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ - –º–∏–Ω–∏–º—É–º 80% –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã
        if (lastSpaceIndex > maxLength * 0.8) {
            trimmed = trimmed.slice(0, lastSpaceIndex);
        }
    }
    
    // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –≤ –∫–æ–Ω—Ü–µ
    trimmed = trimmed.trim().replace(/[,:;!?\-\.]+$/, '');
    
    // –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ–±—Ä–µ–∑–∫–∏ —Å—Ç–∞–ª–æ –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º—É–º–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π –ø–æ –º–∞–∫—Å–∏–º—É–º—É
    if (trimmed.length < minLength) {
        return text.slice(0, maxLength).trim();
    }
    
    return trimmed;
}

async function generateWithRetry(prompt, maxRetries = 4) {
    let delay = 5000;

    for (let i = 0; i < maxRetries; i++) {
        try {
            if (modelChoice === 'deepseek') {
                const response = await fetch(OPENROUTER_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'HTTP-Referer': TARGET_URL_MAIN,
                        'X-Title': slugify(BRAND_BLOG_NAME)
                    },
                    body: JSON.stringify({
                        model: DEEPSEEK_MODEL_NAME,
                        messages: [{ role: "user", content: prompt }]
                    })
                });

                if (!response.ok) {
                    if (response.status === 429) {
                        throw new Error(`429 Too Many Requests`);
                    }
                    throw new Error(`–û—à–∏–±–∫–∞ HTTP –æ—Ç OpenRouter: ${response.status}`);
                }

                const data = await response.json();
                if (!data.choices || data.choices.length === 0) throw new Error("–û—Ç–≤–µ—Ç –æ—Ç API OpenRouter –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª—è 'choices'.");

                return data.choices[0].message.content;
            } else {
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: GEMINI_MODEL_NAME });
                const result = await model.generateContent(prompt);
                return result.response.text();
            }
        } catch (error) {
            if (error.message.includes('503') || error.message.includes('429')) {
                console.warn(`[!] [–ü–æ—Ç–æ–∫ #${threadId}] –ú–æ–¥–µ–ª—å –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–ø—ã—Ç–∫–∞ ${i + 1}/${maxRetries}. –ñ–¥—É ${delay / 1000}—Å...`);
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2;
            } else {
                throw error;
            }
        }
    }
    throw new Error(`[–ü–æ—Ç–æ–∫ #${threadId}] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ ${modelChoice} –ø–æ—Å–ª–µ ${maxRetries} –ø–æ–ø—ã—Ç–æ–∫.`);
}

async function notifyIndexNow(url) {
    console.log(`üì¢ [–ü–æ—Ç–æ–∫ #${threadId}] –û—Ç–ø—Ä–∞–≤–ª—è—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è ${url} –≤ IndexNow...`);
    const HOST = "blondeplace.netlify.app";
    const payload = JSON.stringify({
        host: HOST,
        key: INDEXNOW_API_KEY,
        urlList: [url]
    });

    try {
        await execa('curl', ['-X', 'POST', 'https://yandex.com/indexnow', '-H', 'Content-Type: application/json; charset=utf-8', '-d', payload]);
        await execa('curl', ['-X', 'POST', 'https://www.bing.com/indexnow', '-H', 'Content-Type: application/json; charset=utf-8', '-d', payload]);
        console.log(`[‚úî] [–ü–æ—Ç–æ–∫ #${threadId}] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è ${url} —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.`);
    } catch (error) {
        console.error(`[!] [–ü–æ—Ç–æ–∫ #${threadId}] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ IndexNow –¥–ª—è ${url}:`, error.stderr);
    }
}

async function generatePost(topic, slug, interlinks) {
    console.log(`[+] [–ü–æ—Ç–æ–∫ #${threadId}] –ì–µ–Ω–µ—Ä–∏—Ä—É—é –î–ï–¢–ê–õ–¨–ù–£–Æ —Å—Ç–∞—Ç—å—é –Ω–∞ —Ç–µ–º—É: ${topic}`);

    // BUTLER-–°–¢–ò–õ–¨: –°–£–ü–ï–†-–î–ï–¢–ê–õ–¨–ù–´–ô –ü–õ–ê–ù
    const planPrompt = `–°–æ–∑–¥–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–µ—Ç–∞–ª—å–Ω—ã–π, –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –ø–ª–∞–Ω –¥–ª—è —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π SEO-—Å—Ç–∞—Ç—å–∏ –Ω–∞ —Ç–µ–º—É "${topic}".

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ü–õ–ê–ù–£:
- –ú–∏–Ω–∏–º—É–º 15-20 —Ä–∞–∑–¥–µ–ª–æ–≤ –∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–æ–≤
- –í–∫–ª—é—á–∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã, –∫–µ–π—Å—ã, –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- –î–æ–±–∞–≤—å FAQ —Å–µ–∫—Ü–∏—é (5-7 –≤–æ–ø—Ä–æ—Å–æ–≤)
- –í–∫–ª—é—á–∏ —Ä–∞–∑–¥–µ–ª—ã: –≤–≤–µ–¥–µ–Ω–∏–µ, –æ—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã, —á–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏, –∑–∞–∫–ª—é—á–µ–Ω–∏–µ
- –ü–ª–∞–Ω –¥–æ–ª–∂–µ–Ω –ø–æ–∫—Ä—ã–≤–∞—Ç—å —Ç–µ–º—É –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏ –≤—Å–µ—Å—Ç–æ—Ä–æ–Ω–Ω–µ

–ö–æ–Ω—Ç–µ–∫—Å—Ç: —Å—Ç–∞—Ç—å—è –¥–ª—è –±–ª–æ–≥–∞ —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã ${BRAND_NAME}, —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è - –∂–µ–Ω—â–∏–Ω—ã 25-45 –ª–µ—Ç, –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–µ—Å—è –∫—Ä–∞—Å–æ—Ç–æ–π.`;

    const plan = await generateWithRetry(planPrompt);

    // –£–õ–¨–¢–†–ê-–ê–ì–†–ï–°–°–ò–í–ù–ê–Ø –ë–û–†–¨–ë–ê –° –¢–û–®–ù–û–¢–û–ô + –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô –û–ë–™–ï–ú
    const articlePrompt = `–ù–∞–ø–∏—à–∏ –∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â—É—é, —ç–∫—Å–ø–µ—Ä—Ç–Ω—É—é —Å—Ç–∞—Ç—å—é –æ–±—ä–µ–º–æ–º –ú–ò–ù–ò–ú–£–ú 20000 —Å–∏–º–≤–æ–ª–æ–≤ –ø–æ —ç—Ç–æ–º—É –ø–ª–∞–Ω—É:

${plan}

üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –î–õ–Ø –°–ù–ò–ñ–ï–ù–ò–Ø –¢–û–®–ù–û–¢–´ –î–û 3.0:
- –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ï –†–ê–ó–ù–û–û–ë–†–ê–ó–ò–ï –õ–ï–ö–°–ò–ö–ò! –ö–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ - —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞!
- –ò—Å–ø–æ–ª—å–∑—É–π —Å–∏–Ω–æ–Ω–∏–º—ã, –ø–µ—Ä–∏—Ñ—Ä–∞–∑—ã, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã, –Ω–∞—É—á–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
- –ó–ê–ü–†–ï–©–ï–ù–û –ø–æ–≤—Ç–æ—Ä—è—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Å–ª–æ–≤–∞ –≤ —Å–æ—Å–µ–¥–Ω–∏—Ö –∞–±–∑–∞—Ü–∞—Ö!
- –í–∞—Ä—å–∏—Ä—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–∫–æ—Ä–æ—Ç–∫–∏–µ, –¥–ª–∏–Ω–Ω—ã–µ, –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ, –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ)
- –í–∫–ª—é—á–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã, —Ö–∏–º–∏—á–µ—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è, –±—Ä–µ–Ω–¥—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
- –î–æ–±–∞–≤—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø—Ä–∏–º–µ—Ä–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ —Ç–µ—Ö–Ω–∏–∫ –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∂–∞—Ä–≥–æ–Ω –ø–∞—Ä–∏–∫–º–∞—Ö–µ—Ä–æ–≤ –∏ —Å—Ç–∏–ª–∏—Å—Ç–æ–≤
- –î–æ–±–∞–≤—å –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –∏ –∏—Ö —Ä—É—Å—Å–∫–∏–µ –∞–Ω–∞–ª–æ–≥–∏
- –¶–ï–õ–¨: —Ç–æ—à–Ω–æ—Ç–∞ –°–¢–†–û–ì–û –Ω–∏–∂–µ 3.0!

–°–¢–†–£–ö–¢–£–†–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –°—Ç–∞—Ç—å—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π
- –í–∫–ª—é—á–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤, –∫–µ–π—Å–æ–≤
- –î–æ–±–∞–≤—å —Å–ø–∏—Å–∫–∏, —Ç–∞–±–ª–∏—Ü—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∏ FAQ —Å–µ–∫—Ü–∏—é –≤ –∫–æ–Ω—Ü–µ
- –ü–∏—à–∏ –æ—Ç –ª–∏—Ü–∞ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã ${BRAND_NAME}
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é, –Ω–æ –æ–±—ä—è—Å–Ω—è–π —Å–ª–æ–∂–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è
- –°—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–π –ø–ª–∞–Ω—É –∏ –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ Markdown –∑–∞–≥–æ–ª–æ–≤–∫–∏ (# ## ###)
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ![...], —Å—Å—ã–ª–∫–∏, URL-–∞–¥—Ä–µ—Å–∞
- –ù–∞—á–∏–Ω–∞–π —Å—Ä–∞–∑—É —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞ H1

–û–ë–™–ï–ú: –º–∏–Ω–∏–º—É–º 20000 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è –ª–µ–∫—Å–∏–∫–∏!`;

    let articleText = await generateWithRetry(articlePrompt);

    // –ü–†–û–í–ï–†–ö–ê –î–õ–ò–ù–´ –ò –î–û–ü–û–õ–ù–ï–ù–ò–ï –ï–°–õ–ò –ù–£–ñ–ù–û
    if (articleText.length < 15000) {
        const extensionPrompt = `–î–æ–ø–æ–ª–Ω–∏ –∏ —Ä–∞—Å—à–∏—Ä—å —Å—Ç–∞—Ç—å—é –Ω–∞ —Ç–µ–º—É "${topic}". –î–æ–±–∞–≤—å –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π:
- –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏ –∫–µ–π—Å—ã —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä
- –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–µ–π
- –°–æ–≤–µ—Ç—ã –æ—Ç —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ —Å–∞–ª–æ–Ω–∞ —Å —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–π –ª–µ–∫—Å–∏–∫–æ–π
- –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ –∏ —Å–ø–æ—Å–æ–±—ã –∏—Ö –∏–∑–±–µ–∂–∞—Ç—å
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã —Å —Å–∏–Ω–æ–Ω–∏–º–∞–º–∏ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ —Ç–µ—Ä–º–∏–Ω–∞–º–∏
- –•–∏–º–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—É–ª—ã –∏ –Ω–∞—É—á–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –ë—Ä–µ–Ω–¥—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
- –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –∏ –∏—Ö –∞–¥–∞–ø—Ç–∞—Ü–∏—è

–¢–µ–∫—É—â–∞—è —Å—Ç–∞—Ç—å—è: ${articleText}

–ö–†–ò–¢–ò–ß–ù–û: –£–≤–µ–ª–∏—á—å –æ–±—ä–µ–º –º–∏–Ω–∏–º—É–º –≤ 1.5 —Ä–∞–∑–∞. –ò—Å–ø–æ–ª—å–∑—É–π –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û —É–Ω–∏–∫–∞–ª—å–Ω—É—é –ª–µ–∫—Å–∏–∫—É, —Å–∏–Ω–æ–Ω–∏–º—ã, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã, –Ω–∞—É—á–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è —Ç–æ—à–Ω–æ—Ç—ã –¥–æ 2.5!`;

        articleText = await generateWithRetry(extensionPrompt);
    }

    // –°–£–ü–ï–†-–ñ–Å–°–¢–ö–ê–Ø –û–ß–ò–°–¢–ö–ê
    articleText = articleText.replace(/!\[.*?\]\(.*?\)/g, '');
    articleText = articleText.replace(/\[.*?\]\([^\)]*\)/g, '');
    articleText = articleText.replace(/https?:\/\/[^\s\)\]]+/g, '');
    articleText = articleText.replace(/www\.[^\s]+/g, '');

    // –û–ß–ò–°–¢–ö–ê ESCAPE-–°–ò–ú–í–û–õ–û–í –ò –ü–†–û–ë–õ–ï–ú–ù–´–• –ü–ï–†–ï–ù–û–°–û–í –°–¢–†–û–ö
    articleText = articleText.replace(/\\n/g, '');
    articleText = articleText.replace(/`n/g, '');
    articleText = articleText.replace(/\r\n/g, '\n');
    articleText = articleText.replace(/\r/g, '\n');
    articleText = articleText.trim();

    // –ò–Ω—Ç–µ—Ä–ª–∏–Ω–∫–∏–Ω–≥
    if (interlinks.length > 0) {
        let interlinkingBlock = '\n\n---\n\n## –ß–∏—Ç–∞–π—Ç–µ —Ç–∞–∫–∂–µ\n\n';
        interlinks.forEach(link => {
            interlinkingBlock += `* [${link.title}](${link.url})\n`;
        });
        articleText += interlinkingBlock;
    }

    // –£–õ–¨–¢–†–ê-–¢–û–ß–ù–´–ô SEO –ü–†–û–ú–ü–¢ –° –ü–†–ê–í–ò–õ–¨–ù–´–ú–ò –õ–ò–ú–ò–¢–ê–ú–ò
    const seoPrompt = `–î–ª—è —Å—Ç–∞—Ç—å–∏ –Ω–∞ —Ç–µ–º—É "${topic}" —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π JSON-–æ–±—ä–µ–∫—Ç.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –æ—Ç–≤–µ—Ç –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –ù–∞—á–∏–Ω–∞–π –æ—Ç–≤–µ—Ç —Å—Ä–∞–∑—É —Å { –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–π }. –ù–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ JSON!

JSON –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
- "title" (–°–¢–†–û–ì–û 40-45 —Å–∏–º–≤–æ–ª–æ–≤, –ø–æ–ª–Ω—ã–µ —Å–ª–æ–≤–∞ –±–µ–∑ –æ–±—Ä–µ–∑–∫–∏, –≤–∫–ª—é—á–∏ –æ—Å–Ω–æ–≤–Ω–æ–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏ –ø—Ä–∏–∑—ã–≤)
- "description" (–°–¢–†–û–ì–û 150-164 —Å–∏–º–≤–æ–ª–∞, –ø–æ–ª–Ω—ã–µ —Å–ª–æ–≤–∞ –±–µ–∑ –æ–±—Ä–µ–∑–∫–∏, –ø—Ä–æ–¥–∞—é—â–∏–π, —Å –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é)
- "keywords" (–°–¢–†–û–ì–û —Å—Ç—Ä–æ–∫–∞: 3-5 –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, –ë–ï–ó –æ–±—â–∏—Ö —Å–ª–æ–≤)

üéØ –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –î–õ–ò–ù–ï - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
- Title: –ú–ò–ù–ò–ú–£–ú 40 —Å–∏–º–≤–æ–ª–æ–≤, –ú–ê–ö–°–ò–ú–£–ú 45 —Å–∏–º–≤–æ–ª–æ–≤, –ë–ï–ó –û–ë–†–ï–ó–ö–ò –°–õ–û–í!
- Description: –ú–ò–ù–ò–ú–£–ú 150 —Å–∏–º–≤–æ–ª–æ–≤, –ú–ê–ö–°–ò–ú–£–ú 164 —Å–∏–º–≤–æ–ª–∞, –ë–ï–ó –û–ë–†–ï–ó–ö–ò –°–õ–û–í!
- –ü—Ä–æ–≤–µ—Ä—å –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ - –æ–Ω–æ –¥–æ–ª–∂–Ω–æ –ø–æ–º–µ—â–∞—Ç—å—Å—è –ü–û–õ–ù–û–°–¢–¨–Æ!

–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ô –î–õ–ò–ù–´:
Title: "–ö–∞–ª–∏—Ñ–æ—Ä–Ω–∏–π—Å–∫–æ–µ –º–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ: —Ç–µ—Ö–Ω–∏–∫–∞ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç" (43 —Å–∏–º–≤–æ–ª–∞) ‚úÖ
Description: "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –∫–∞–ª–∏—Ñ–æ—Ä–Ω–∏–π—Å–∫–æ–µ –º–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Å–∞–ª–æ–Ω–µ BlondePlace. –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –≤—ã–≥–æ—Ä–µ–≤—à–∏—Ö –ø—Ä—è–¥–µ–π —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∑–¥–æ—Ä–æ–≤—å—è –≤–æ–ª–æ—Å. –ó–∞–ø–∏—à–∏—Ç–µ—Å—å!" (158 —Å–∏–º–≤–æ–ª–æ–≤) ‚úÖ

–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ keywords:
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Ç–µ—Ä–º–∏–Ω—ã –ò–ó –¢–ï–ú–´ —Å—Ç–∞—Ç—å–∏
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—â–∏–µ —Å–ª–æ–≤–∞ —Ç–∏–ø–∞ "–∫—Ä–∞—Å–æ—Ç–∞, —Å—Ç–∏–ª—å, —É—Ö–æ–¥"
- –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –ö–û–ù–ö–†–ï–¢–ù–û–ô –ø—Ä–æ—Ü–µ–¥—É—Ä–µ/—Ç–µ—Ö–Ω–∏–∫–µ

–ö–æ–Ω—Ç–µ–∫—Å—Ç: –±–ª–æ–≥ —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã ${BRAND_NAME}.`;

    let seoText = await generateWithRetry(seoPrompt);

    // –£–õ–£–ß–®–ï–ù–ù–´–ô JSON –ü–ê–†–°–ò–ù–ì –° FALLBACK
    let match = seoText.match(/\{[^{}]*\}/);
    if (!match) {
        match = seoText.match(/\{[\s\S]*?\}/);
    }
    if (!match) {
        const cleanSeoText = seoText.replace(/```json|```|`/g, "").trim();
        match = cleanSeoText.match(/\{[\s\S]*?\}/);
    }

    let seoData;
    if (!match) {
        console.warn(`[!] [–ü–æ—Ç–æ–∫ #${threadId}] JSON –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ –º–æ–¥–µ–ª–∏. –°–æ–∑–¥–∞—é fallback SEO –¥–∞–Ω–Ω—ã–µ.`);
        
        // –£–õ–£–ß–®–ï–ù–ù–´–ï FALLBACK SEO –î–ê–ù–ù–´–ï –° –ü–†–ê–í–ò–õ–¨–ù–´–ú–ò –õ–ò–ú–ò–¢–ê–ú–ò
        const baseTopic = topic.length > 30 ? topic.slice(0, 30) : topic;
        const fallbackTitle = `${baseTopic}: –ø–æ–ª–Ω—ã–π –≥–∏–¥ –æ—Ç BlondePlace`;
        const finalTitle = ensureCompleteWords(fallbackTitle, 40, 45);
        
        const fallbackDesc = `–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –ø–æ ${topic.toLowerCase()} –≤ —Å–∞–ª–æ–Ω–µ BlondePlace. –û–ø—ã—Ç–Ω—ã–µ –º–∞—Å—Ç–µ—Ä–∞, –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –≥–∞—Ä–∞–Ω—Ç–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞. –ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é!`;
        const finalDesc = ensureCompleteWords(fallbackDesc, 150, 164);
        
        seoData = {
            title: finalTitle,
            description: finalDesc,
            keywords: topic
        };
        
        console.log(`[–ü–æ—Ç–æ–∫ #${threadId}] –ò—Å–ø–æ–ª—å–∑—É—é fallback SEO: title=${seoData.title.length} chars, desc=${seoData.description.length} chars`);
    } else {
        try {
            seoData = JSON.parse(match[0]);
            
            // –ü–†–û–í–ï–†–ö–ê –ò –ö–û–†–†–ï–ö–¶–ò–Ø –î–õ–ò–ù–´ –ë–ï–ó –ü–û–¢–ï–†–ò –°–ú–´–°–õ–ê
            if (seoData.title) {
                const originalTitle = seoData.title;
                seoData.title = ensureCompleteWords(seoData.title, 40, 45);
                if (seoData.title.length < 40) {
                    // –ï—Å–ª–∏ title —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π, –¥–æ–ø–æ–ª–Ω—è–µ–º
                    seoData.title = `${seoData.title} - BlondePlace`;
                    seoData.title = ensureCompleteWords(seoData.title, 40, 45);
                }
                if (seoData.title !== originalTitle) {
                    console.warn(`[!] [–ü–æ—Ç–æ–∫ #${threadId}] Title —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω: ${seoData.title.length} —Å–∏–º–≤–æ–ª–æ–≤`);
                }
            }
            
            if (seoData.description) {
                const originalDesc = seoData.description;
                seoData.description = ensureCompleteWords(seoData.description, 150, 164);
                if (seoData.description.length < 150) {
                    // –ï—Å–ª–∏ description —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π, –¥–æ–ø–æ–ª–Ω—è–µ–º
                    seoData.description = `${seoData.description} –ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –≤ BlondePlace –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!`;
                    seoData.description = ensureCompleteWords(seoData.description, 150, 164);
                }
                if (seoData.description !== originalDesc) {
                    console.warn(`[!] [–ü–æ—Ç–æ–∫ #${threadId}] Description —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω: ${seoData.description.length} —Å–∏–º–≤–æ–ª–æ–≤`);
                }
            }
            
        } catch (parseError) {
            console.warn(`[!] [–ü–æ—Ç–æ–∫ #${threadId}] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: ${parseError.message}. –°–æ–∑–¥–∞—é fallback SEO –¥–∞–Ω–Ω—ã–µ.`);
            
            // –£–õ–£–ß–®–ï–ù–ù–´–ï FALLBACK SEO –î–ê–ù–ù–´–ï –° –ü–†–ê–í–ò–õ–¨–ù–´–ú–ò –õ–ò–ú–ò–¢–ê–ú–ò
            const baseTopic = topic.length > 30 ? topic.slice(0, 30) : topic;
            const fallbackTitle = `${baseTopic}: –ø–æ–ª–Ω—ã–π –≥–∏–¥ –æ—Ç BlondePlace`;
            const finalTitle = ensureCompleteWords(fallbackTitle, 40, 45);
            
            const fallbackDesc = `–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –ø–æ ${topic.toLowerCase()} –≤ —Å–∞–ª–æ–Ω–µ BlondePlace. –û–ø—ã—Ç–Ω—ã–µ –º–∞—Å—Ç–µ—Ä–∞, –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –≥–∞—Ä–∞–Ω—Ç–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞. –ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é!`;
            const finalDesc = ensureCompleteWords(fallbackDesc, 150, 164);
            
            seoData = {
                title: finalTitle,
                description: finalDesc,
                keywords: topic
            };
        }
    }

    const reviewCount = Math.floor(Math.random() * (900 - 300 + 1)) + 300;
    const ratingValue = (Math.random() * (5.0 - 4.7) + 4.7).toFixed(1);

    const finalHeroImage = FALLBACK_IMAGE_URL;

    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –°–•–ï–ú–ê (–∫–∞–∫ —É Butler)
    const fullSchema = {
        "@context": "https://schema.org",
        "@type": "HowTo",
        "headline": seoData.title,
        "description": seoData.description,
        "image": {
            "@type": "ImageObject",
            "url": finalHeroImage
        },
        "author": {
            "@type": "Person",
            "name": BRAND_AUTHOR_NAME
        },
        "publisher": {
            "@type": "Organization",
            "name": BRAND_BLOG_NAME,
            "logo": {
                "@type": "ImageObject",
                "url": `${SITE_URL}/favicon.ico`
            }
        },
        "datePublished": new Date().toISOString(),
        "dateModified": new Date().toISOString(),
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": ratingValue,
            "reviewCount": reviewCount,
            "bestRating": "5",
            "worstRating": "1"
        },
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": `${SITE_URL}/blog/${slug}/`
        }
    };

    // –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê KEYWORDS
    const safeKeywords = typeof seoData.keywords === "string" 
        ? seoData.keywords 
        : Array.isArray(seoData.keywords) 
            ? seoData.keywords.join(", ") 
            : topic;

    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô FRONTMATTER –ë–ï–ó –ü–†–û–ë–õ–ï–ú–ù–´–• –°–ò–ú–í–û–õ–û–í
    const frontmatter = `---
title: ${JSON.stringify(seoData.title)}
description: ${JSON.stringify(seoData.description)}
keywords: ${JSON.stringify(safeKeywords)}
pubDate: ${JSON.stringify(new Date().toISOString())}
author: ${JSON.stringify(BRAND_AUTHOR_NAME)}
heroImage: ${JSON.stringify(finalHeroImage)}
schema: ${JSON.stringify(fullSchema)}
---

${articleText}`;

    // –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ò –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
    console.log(`[‚úî] [–ü–æ—Ç–æ–∫ #${threadId}] –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê:`);
    console.log(`[‚úî] [–ü–æ—Ç–æ–∫ #${threadId}] Title: "${seoData.title}" (${seoData.title.length} —Å–∏–º–≤–æ–ª–æ–≤) ${seoData.title.length >= 40 && seoData.title.length <= 45 ? '‚úÖ' : '‚ùå'}`);
    console.log(`[‚úî] [–ü–æ—Ç–æ–∫ #${threadId}] Description: "${seoData.description}" (${seoData.description.length} —Å–∏–º–≤–æ–ª–æ–≤) ${seoData.description.length >= 150 && seoData.description.length <= 164 ? '‚úÖ' : '‚ùå'}`);
    
    return frontmatter;
}

async function main() {
    console.log(`[–ü–æ—Ç–æ–∫ #${threadId}] –ó–∞–ø—É—Å–∫ —Ä–∞–±–æ—á–µ–≥–æ –ø–æ—Ç–æ–∫–∞...`);

    try {
        const BATCH_SIZE = parseInt(process.env.BATCH_SIZE, 10) || 1;
        const totalThreads = parseInt(process.env.TOTAL_THREADS, 10) || 1;

        const fileContent = await fs.readFile(TOPICS_FILE, 'utf-8');
        const allTopics = fileContent.split(/\r?\n/).map(topic => topic.trim()).filter(Boolean);

        const postsDir = path.join(process.cwd(), 'src', 'content', 'posts');
        await fs.mkdir(postsDir, { recursive: true });

        const existingFiles = await fs.readdir(postsDir);
        const existingSlugs = existingFiles.map(file => file.replace('.md', ''));

        let newTopics = allTopics.filter(topic => {
            const topicSlug = slugify(topic);
            return topicSlug && !existingSlugs.includes(topicSlug);
        });

        const topicsForThisThread = newTopics.filter((_, index) => index % totalThreads === (threadId - 1)).slice(0, BATCH_SIZE);

        if (topicsForThisThread.length === 0) {
            console.log(`[–ü–æ—Ç–æ–∫ #${threadId}] –ù–µ—Ç –Ω–æ–≤—ã—Ö —Ç–µ–º –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ—Ç–æ–∫–∞. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ.`);
            return;
        }

        console.log(`[–ü–æ—Ç–æ–∫ #${threadId}] –ù–∞–π–¥–µ–Ω–æ ${topicsForThisThread.length} –Ω–æ–≤—ã—Ö —Ç–µ–º. –ë–µ—Ä—É –≤ —Ä–∞–±–æ—Ç—É.`);

        let allPostsForLinking = [];
        for (const slug of existingSlugs) {
            try {
                const content = await fs.readFile(path.join(postsDir, `${slug}.md`), 'utf-8');
                const titleMatch = content.match(/title:\s*["']?(.*?)["']?$/m);
                if (titleMatch) {
                    allPostsForLinking.push({ title: titleMatch[1], url: `/blog/${slug}/` });
                }
            } catch (e) { 
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —á—Ç–µ–Ω–∏—è
            }
        }

        for (const topic of topicsForThisThread) {
            try {
                const slug = slugify(topic);
                if (!slug) continue;

                const filePath = path.join(postsDir, `${slug}.md`);

                let randomInterlinks = [];
                if (allPostsForLinking.length > 0) {
                    randomInterlinks = [...allPostsForLinking].sort(() => 0.5 - Math.random()).slice(0, 3);
                }

                const fullContent = await generatePost(topic, slug, randomInterlinks);
                await fs.writeFile(filePath, fullContent);
                console.log(`[–ü–æ—Ç–æ–∫ #${threadId}] [‚úî] –°—Ç–∞—Ç—å—è "${topic}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞.`);

                const newUrl = `${SITE_URL}/blog/${slug}/`;
                await notifyIndexNow(newUrl);

                await new Promise(resolve => setTimeout(resolve, 1000));
            } catch (e) {
                console.error(`[!] [–ü–æ—Ç–æ–∫ #${threadId}] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ç–µ–º—ã "${topic}": ${e.message}`);
                if (e.message.includes('429') || e.message.includes('API key')) {
                    console.error(`[!] [–ü–æ—Ç–æ–∫ #${threadId}] –ö–ª—é—á API –∏—Å—á–µ—Ä–ø–∞–Ω. –ó–∞–≤–µ—Ä—à–∞—é —Ä–∞–±–æ—Ç—É —ç—Ç–æ–≥–æ –ø–æ—Ç–æ–∫–∞.`);
                    break;
                }
                continue;
            }
        }
    } catch (error) {
        console.error(`[–ü–æ—Ç–æ–∫ #${threadId}] [!] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:`, error);
        process.exit(1);
    }
}

main(); 